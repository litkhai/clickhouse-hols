version: '3.8'

services:
  # MongoDB for LibreChat
  mongodb:
    image: mongo:7.0
    container_name: librechat-mongodb
    restart: unless-stopped
    volumes:
      - mongodb-data:/data/db
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
    networks:
      - librechat-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5

  # LibreChat with Ollama support
  librechat:
    image: ghcr.io/danny-avila/librechat:latest
    container_name: librechat
    restart: unless-stopped
    ports:
      - "${LIBRECHAT_PORT:-3080}:3080"
    depends_on:
      mongodb:
        condition: service_healthy
    environment:
      # MongoDB
      MONGO_URI: mongodb://admin:admin123@mongodb:27017/LibreChat?authSource=admin

      # App settings
      HOST: 0.0.0.0
      PORT: 3080
      SESSION_SECRET: ${SESSION_SECRET}

      # Ollama configuration
      ENDPOINTS: ollama
      OLLAMA_BASE_URL: ${OLLAMA_BASE_URL:-http://host.docker.internal:11434}

      # MCP Server configuration
      MCP_ENABLED: true
      MCP_SERVER_URL: http://mcp-server:${MCP_SERVER_PORT:-3001}

      # Security
      ALLOW_REGISTRATION: true
      ALLOW_UNVERIFIED_EMAIL: true

      # Debug (optional)
      DEBUG_CONSOLE: false
      DEBUG_LOGGING: false

    volumes:
      - ./librechat-data:/app/data
      - ./librechat.yaml:/app/librechat.yaml:ro
    networks:
      - librechat-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ClickHouse MCP Server
  mcp-server:
    image: node:20-alpine
    container_name: clickhouse-mcp-server
    restart: unless-stopped
    working_dir: /app
    command: >
      sh -c "
        if [ ! -f package.json ]; then
          npm init -y &&
          npm install @modelcontextprotocol/server-clickhouse express;
        fi &&
        node server.js
      "
    volumes:
      - ./mcp-server:/app
      - ./mcp-server/server.js:/app/server.js:ro
    environment:
      # ClickHouse connection
      CLICKHOUSE_HOST: ${CH_HOST:-localhost}
      CLICKHOUSE_PORT: ${CH_PORT:-8123}
      CLICKHOUSE_USER: ${CH_USER:-default}
      CLICKHOUSE_PASSWORD: ${CH_PASSWORD}
      CLICKHOUSE_DATABASE: ${CH_DATABASE:-default}

      # MCP Server settings
      PORT: ${MCP_SERVER_PORT:-3001}
      NODE_ENV: production
    networks:
      - librechat-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  mongodb-data:
    driver: local

networks:
  librechat-network:
    driver: bridge
