services:
  clickhouse:
    image: clickhouse/clickhouse-server:24.9
    container_name: clickhouse-oss
    hostname: clickhouse
    ports:
      - "8123:8123"  # HTTP Interface
      - "9000:9000"  # TCP Interface
    volumes:
      - clickhouse_data:/var/lib/clickhouse
      - clickhouse_logs:/var/log/clickhouse-server
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: default
      CLICKHOUSE_PASSWORD: ""
    restart: unless-stopped
    
    # ğŸš€ ë¦¬ì†ŒìŠ¤ ì œí•œ ë° í• ë‹¹
    deploy:
      resources:
        limits:
          cpus: '4.0'           # CPU ì½”ì–´ 4ê°œë¡œ ì œí•œ
          memory: 8G            # ë©”ëª¨ë¦¬ 8GBë¡œ ì œí•œ
        reservations:
          cpus: '2.0'           # CPU ì½”ì–´ 2ê°œ ì˜ˆì•½
          memory: 4G            # ë©”ëª¨ë¦¬ 4GB ì˜ˆì•½
    
    # ğŸ§  ë©”ëª¨ë¦¬ ì„¤ì •
    mem_limit: 8g               # ì»¨í…Œì´ë„ˆ ë©”ëª¨ë¦¬ ì œí•œ
    mem_reservation: 4g         # ë©”ëª¨ë¦¬ ì˜ˆì•½
    memswap_limit: 8g          # ìŠ¤ì™‘ í¬í•¨ ë©”ëª¨ë¦¬ ì œí•œ
    
    # âš¡ CPU ì„¤ì •
    cpus: 4                     # CPU ì½”ì–´ ìˆ˜
    cpu_shares: 1024           # CPU ìš°ì„ ìˆœìœ„ (ê¸°ë³¸ê°’: 1024)
    
    # ğŸ”§ ì‹œìŠ¤í…œ ì œí•œ
    ulimits:
      nofile:
        soft: 262144           # íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° ì†Œí”„íŠ¸ ì œí•œ
        hard: 262144           # íŒŒì¼ ë””ìŠ¤í¬ë¦½í„° í•˜ë“œ ì œí•œ
      memlock:
        soft: -1               # ë©”ëª¨ë¦¬ ë½ ì œí•œ í•´ì œ
        hard: -1
    
    # ğŸƒ ì„±ëŠ¥ ìµœì í™”
    shm_size: 2g               # ê³µìœ  ë©”ëª¨ë¦¬ í¬ê¸°
    
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8123/ping"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s

volumes:
  clickhouse_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /Users/kenlee/clickhouse/oss/data  # ë¡œì»¬ SSD ì‚¬ìš©
  clickhouse_logs:
    driver: local

networks:
  default:
    name: clickhouse-network
    driver: bridge

