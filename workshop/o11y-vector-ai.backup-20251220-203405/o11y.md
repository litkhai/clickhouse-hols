ClickHouse Agentic AI & Vector Search in Observability

ClickHouse Agentic AI & Vector Search Demo Project
프로젝트 계획서

1. 프로젝트 개요
목표
ClickHouse Vector Search + Agentic AI를 활용한 Observability 데모 환경 구축
핵심 시나리오

유사 에러 로그 검색: Vector Index로 "이 에러와 비슷한 과거 로그" 즉시 탐색
이상 트레이스 탐지: Embedding 기반 정상/비정상 패턴 분류
Agentic 워크플로우: MCP를 통해 AI가 직접 ClickHouse를 쿼리하며 근본 원인 분석

기술 스택
구성요소기술Data GeneratorPython + OpenTelemetry SDKSample AppFastAPI (E-commerce 시뮬레이션)OTEL CollectorOpenTelemetry CollectorVisualizationHyperDX (Self-hosted)StorageClickHouse CloudEmbeddingOpenAI ada-002 / 로컬 모델AI AgentClaude + MCPInfraAWS EC2

2. 아키텍처
┌─────────────────────────────────────────────────────────────────┐
│                        AWS EC2 Instance                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │  Sample App     │  │  Data Generator │  │  Session        │  │
│  │  (FastAPI)      │  │  (Error/Traffic)│  │  Replay Agent   │  │
│  │  - /checkout    │  │  - Normal flow  │  │  (rrweb)        │  │
│  │  - /payment     │  │  - Error inject │  │                 │  │
│  │  - /inventory   │  │  - Anomaly      │  │                 │  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
│           │                    │                    │           │
│           └────────────────────┼────────────────────┘           │
│                                ▼                                │
│                    ┌─────────────────────┐                      │
│                    │  OTEL Collector     │                      │
│                    │  + HyperDX Agent    │                      │
│                    └──────────┬──────────┘                      │
└───────────────────────────────┼─────────────────────────────────┘
                                │
                                ▼
┌───────────────────────────────────────────────────────────────────┐
│                      ClickHouse Cloud                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────────┐ │
│  │ otel_logs    │  │ otel_traces  │  │ otel_sessions            │ │
│  │              │  │              │  │ (+ session_replay)       │ │
│  └──────┬───────┘  └──────┬───────┘  └──────────┬───────────────┘ │
│         │                 │                     │                 │
│         └─────────────────┼─────────────────────┘                 │
│                           ▼                                       │
│              ┌─────────────────────────┐                          │
│              │  Embedding Pipeline     │                          │
│              │  (Materialized View +   │                          │
│              │   External UDF/Batch)   │                          │
│              └────────────┬────────────┘                          │
│                           ▼                                       │
│  ┌──────────────────────────────────────────────────────────────┐ │
│  │  logs_with_embeddings / traces_with_embeddings               │ │
│  │  + Vector Index (usearch)                                    │ │
│  └──────────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌───────────────────────────────────────────────────────────────────┐
│                        Query Layer                                │
│  ┌─────────────────┐           ┌─────────────────────────────────┐│
│  │   HyperDX UI    │           │  Claude + MCP                   ││
│  │   (Dashboard)   │           │  (Agentic Root Cause Analysis)  ││
│  └─────────────────┘           └─────────────────────────────────┘│
└───────────────────────────────────────────────────────────────────┘

3. 상세 구성요소
3.1 Sample Application (FastAPI E-commerce)
목적: 실제 서비스를 시뮬레이션하여 Traces, Logs, Sessions 생성
엔드포인트 설계:
Endpoint기능에러 시나리오GET /메인 페이지-GET /products상품 목록DB 타임아웃GET /products/{id}상품 상세404 Not FoundPOST /cart/add장바구니 추가재고 부족POST /checkout결제 시작Payment Gateway 오류POST /payment결제 처리타임아웃, 중복 결제GET /inventory/check재고 확인DB Connection Pool 고갈
OTEL Instrumentation:
python# 주요 구성
- opentelemetry-instrumentation-fastapi
- opentelemetry-instrumentation-requests
- opentelemetry-instrumentation-sqlalchemy
- Custom spans for business logic
3.2 Data Generator
목적: 다양한 트래픽 패턴 및 에러 시나리오 자동 생성
생성 패턴:
패턴비율설명Normal Flow70%정상 사용자 여정 (browse → cart → checkout → payment)Error Injection15%의도적 에러 (timeout, 500, connection error)Anomaly Pattern10%비정상 패턴 (rapid retry, unusual sequence)Edge Cases5%경계 조건 (large payload, special characters)
에러 시나리오 (데모용):
yamlscenarios:
  - name: "payment_timeout"
    description: "Payment Gateway 타임아웃 - DB Connection Pool 고갈로 인한"
    trigger_rate: 5%
    root_cause: "inventory_service_db_pool_exhaustion"
    
  - name: "cascade_failure"
    description: "Inventory → Payment → Checkout 연쇄 장애"
    trigger_rate: 2%
    root_cause: "inventory_service_memory_leak"
    
  - name: "intermittent_error"
    description: "간헐적 500 에러"
    trigger_rate: 3%
    root_cause: "race_condition_in_cart_update"
3.3 Session Replay (rrweb)
목적: 사용자 세션을 녹화하여 HyperDX Session Replay 기능 활용
구성:
javascript// Frontend에 rrweb 통합
import { record } from 'rrweb';

record({
  emit(event) {
    // OTEL Collector로 전송
    sendToCollector(event);
  },
});
캡처 항목:

DOM mutations
Mouse movements & clicks
Scroll events
Input changes (마스킹 처리)
Network requests correlation

3.4 HyperDX 연동
Self-hosted 구성:
yaml# docker-compose.yml 핵심 구성
services:
  hyperdx-api:
    image: hyperdx/hyperdx-api
    environment:
      - CLICKHOUSE_HOST=<clickhouse-cloud-host>
      - CLICKHOUSE_USER=default
      - CLICKHOUSE_PASSWORD=<password>
      
  hyperdx-app:
    image: hyperdx/hyperdx-app
    ports:
      - "8080:8080"
      
  otel-collector:
    image: hyperdx/hyperdx-otel-collector
HyperDX가 제공하는 기능:

Log Explorer
Trace Viewer
Session Replay
Dashboard & Alerts


4. ClickHouse 스키마 설계
4.1 기본 OTEL 테이블 (HyperDX 호환)
sql-- Database
CREATE DATABASE IF NOT EXISTS agentic_otel;

-- Logs 테이블
CREATE TABLE agentic_otel.otel_logs
(
    Timestamp DateTime64(9),
    TraceId String,
    SpanId String,
    TraceFlags UInt8,
    SeverityText LowCardinality(String),
    SeverityNumber UInt8,
    ServiceName LowCardinality(String),
    Body String,
    ResourceAttributes Map(LowCardinality(String), String),
    LogAttributes Map(LowCardinality(String), String),
    
    -- HyperDX 추가 필드
    _platform LowCardinality(String) DEFAULT 'hyperdx',
    _host LowCardinality(String),
    _service LowCardinality(String),
    _timestamp DateTime64(9) ALIAS Timestamp
)
ENGINE = MergeTree()
PARTITION BY toDate(Timestamp)
ORDER BY (ServiceName, SeverityText, Timestamp)
TTL toDate(Timestamp) + INTERVAL 30 DAY;

-- Traces 테이블
CREATE TABLE agentic_otel.otel_traces
(
    Timestamp DateTime64(9),
    TraceId String,
    SpanId String,
    ParentSpanId String,
    TraceState String,
    SpanName LowCardinality(String),
    SpanKind LowCardinality(String),
    ServiceName LowCardinality(String),
    Duration Int64,
    StatusCode LowCardinality(String),
    StatusMessage String,
    SpanAttributes Map(LowCardinality(String), String),
    ResourceAttributes Map(LowCardinality(String), String),
    Events Nested(
        Timestamp DateTime64(9),
        Name LowCardinality(String),
        Attributes Map(LowCardinality(String), String)
    ),
    Links Nested(
        TraceId String,
        SpanId String,
        TraceState String,
        Attributes Map(LowCardinality(String), String)
    )
)
ENGINE = MergeTree()
PARTITION BY toDate(Timestamp)
ORDER BY (ServiceName, SpanName, Timestamp)
TTL toDate(Timestamp) + INTERVAL 30 DAY;

-- Sessions 테이블
CREATE TABLE agentic_otel.otel_sessions
(
    SessionId String,
    UserId String,
    StartTime DateTime64(3),
    EndTime DateTime64(3),
    Duration Int64,
    UserAgent String,
    DeviceType LowCardinality(String),
    OS LowCardinality(String),
    Browser LowCardinality(String),
    Country LowCardinality(String),
    City String,
    PageViews UInt32,
    Events Nested(
        Timestamp DateTime64(3),
        Type LowCardinality(String),
        Name String,
        Attributes Map(String, String)
    ),
    ErrorCount UInt32,
    TraceIds Array(String)
)
ENGINE = MergeTree()
PARTITION BY toDate(StartTime)
ORDER BY (StartTime, SessionId)
TTL toDate(StartTime) + INTERVAL 30 DAY;

-- Session Replay 테이블
CREATE TABLE agentic_otel.session_replay_events
(
    SessionId String,
    Timestamp DateTime64(3),
    SequenceNumber UInt64,
    EventType LowCardinality(String),  -- 'dom', 'mouse', 'scroll', 'input', 'network'
    EventData String,  -- JSON compressed
    
    INDEX idx_session_id SessionId TYPE bloom_filter GRANULARITY 1
)
ENGINE = MergeTree()
PARTITION BY toDate(Timestamp)
ORDER BY (SessionId, Timestamp, SequenceNumber)
TTL toDate(Timestamp) + INTERVAL 7 DAY;
4.2 Vector Search 테이블
sql-- Logs with Embeddings
CREATE TABLE agentic_otel.logs_with_embeddings
(
    Timestamp DateTime64(9),
    TraceId String,
    SpanId String,
    SeverityText LowCardinality(String),
    ServiceName LowCardinality(String),
    Body String,
    
    -- Embedding 필드
    embedding Array(Float32),
    embedding_model LowCardinality(String) DEFAULT 'text-embedding-ada-002',
    
    -- Vector Index
    INDEX vec_idx embedding TYPE usearch(cosine) GRANULARITY 1
)
ENGINE = MergeTree()
PARTITION BY toDate(Timestamp)
ORDER BY (ServiceName, SeverityText, Timestamp);

-- Traces with Embeddings (Trace 시퀀스의 Embedding)
CREATE TABLE agentic_otel.traces_with_embeddings
(
    TraceId String,
    Timestamp DateTime64(9),
    ServiceName LowCardinality(String),
    
    -- Trace 요약 정보
    span_sequence String,  -- "checkout -> payment -> inventory" 형태
    total_duration Int64,
    span_count UInt32,
    error_count UInt32,
    
    -- Embedding 필드
    embedding Array(Float32),
    
    -- 분류 레이블 (학습/추론용)
    is_anomaly UInt8 DEFAULT 0,
    anomaly_type LowCardinality(String) DEFAULT '',
    
    INDEX vec_idx embedding TYPE usearch(cosine) GRANULARITY 1
)
ENGINE = MergeTree()
PARTITION BY toDate(Timestamp)
ORDER BY (ServiceName, Timestamp);

-- Error Patterns (과거 에러 패턴 저장 - RAG용)
CREATE TABLE agentic_otel.error_patterns
(
    pattern_id UUID DEFAULT generateUUIDv4(),
    created_at DateTime64(3) DEFAULT now64(3),
    
    -- 에러 정보
    error_signature String,  -- 에러의 고유 시그니처
    error_message String,
    service_name LowCardinality(String),
    
    -- 근본 원인 및 해결책
    root_cause String,
    resolution String,
    
    -- 관련 메타데이터
    occurrence_count UInt32 DEFAULT 1,
    last_seen DateTime64(3),
    related_trace_ids Array(String),
    
    -- Embedding
    embedding Array(Float32),
    
    INDEX vec_idx embedding TYPE usearch(cosine) GRANULARITY 1
)
ENGINE = MergeTree()
ORDER BY (service_name, created_at);
4.3 Embedding 생성 파이프라인
Option A: Batch Processing (권장 - 데모용)
python# embedding_pipeline.py
import clickhouse_connect
from openai import OpenAI

def generate_embeddings_batch():
    """주기적으로 새 로그에 대해 embedding 생성"""
    
    # 아직 embedding이 없는 로그 조회
    query = """
    SELECT Timestamp, TraceId, SpanId, SeverityText, ServiceName, Body
    FROM agentic_otel.otel_logs
    WHERE (Timestamp, TraceId, SpanId) NOT IN (
        SELECT Timestamp, TraceId, SpanId 
        FROM agentic_otel.logs_with_embeddings
    )
    AND Timestamp > now() - INTERVAL 1 HOUR
    LIMIT 1000
    """
    
    logs = client.query(query).result_rows
    
    # OpenAI Embedding 생성
    texts = [log[5] for log in logs]  # Body
    embeddings = openai_client.embeddings.create(
        model="text-embedding-ada-002",
        input=texts
    )
    
    # ClickHouse에 저장
    # ...
Option B: Real-time with External UDF (고급)
sql-- UDF 등록 (ClickHouse 설정 필요)
CREATE FUNCTION embed AS (text) -> 
    (SELECT embedding FROM url('http://embedding-service/embed', 
     JSONEachRow, 'embedding Array(Float32)') 
     WHERE text = text);

5. Vector Search 쿼리 예시
5.1 유사 에러 로그 검색
sql-- 현재 에러와 유사한 과거 에러 찾기
WITH current_error AS (
    SELECT embedding
    FROM agentic_otel.logs_with_embeddings
    WHERE TraceId = '{current_trace_id}'
    AND SeverityText = 'ERROR'
    LIMIT 1
)
SELECT 
    l.Timestamp,
    l.ServiceName,
    l.Body,
    cosineDistance(l.embedding, ce.embedding) AS distance
FROM agentic_otel.logs_with_embeddings l, current_error ce
WHERE l.SeverityText = 'ERROR'
    AND l.Timestamp < now() - INTERVAL 1 HOUR  -- 과거 로그만
    AND distance < 0.3  -- 유사도 임계값
ORDER BY distance ASC
LIMIT 10;
5.2 이상 트레이스 탐지
sql-- 정상 트레이스 centroid 계산
WITH normal_centroid AS (
    SELECT arrayMap(i -> avg(embedding[i]), range(1, 1537)) AS centroid
    FROM agentic_otel.traces_with_embeddings
    WHERE is_anomaly = 0
)
-- 현재 트레이스와 정상 패턴 간 거리 계산
SELECT 
    TraceId,
    span_sequence,
    total_duration,
    error_count,
    cosineDistance(embedding, nc.centroid) AS anomaly_score
FROM agentic_otel.traces_with_embeddings t, normal_centroid nc
WHERE Timestamp > now() - INTERVAL 10 MINUTE
ORDER BY anomaly_score DESC
LIMIT 20;
5.3 에러 패턴 매칭 (RAG)
sql-- 현재 에러와 가장 유사한 과거 패턴 및 해결책 조회
SELECT 
    ep.error_signature,
    ep.root_cause,
    ep.resolution,
    ep.occurrence_count,
    cosineDistance(ep.embedding, {query_embedding}) AS similarity
FROM agentic_otel.error_patterns ep
WHERE similarity < 0.25
ORDER BY similarity ASC
LIMIT 5;

6. Agentic AI 워크플로우
6.1 MCP Server 설정
json// claude_desktop_config.json
{
  "mcpServers": {
    "clickhouse-otel": {
      "command": "uvx",
      "args": ["mcp-clickhouse"],
      "env": {
        "CLICKHOUSE_HOST": "<your-clickhouse-cloud-host>",
        "CLICKHOUSE_PORT": "8443",
        "CLICKHOUSE_USER": "default",
        "CLICKHOUSE_PASSWORD": "<password>",
        "CLICKHOUSE_SECURE": "true"
      }
    }
  }
}
```

### 6.2 Agentic 시나리오 예시

**시나리오 1: 에러 근본 원인 분석**
```
사용자: "지난 1시간 동안 payment 서비스에서 에러가 급증했어. 원인 분석해줘."

AI Agent 동작:
1. 에러 현황 파악
   → SELECT count(), SeverityText FROM otel_logs 
      WHERE ServiceName = 'payment' AND Timestamp > now() - INTERVAL 1 HOUR
      GROUP BY SeverityText

2. 에러 메시지 분석
   → SELECT Body, count() FROM otel_logs 
      WHERE ServiceName = 'payment' AND SeverityText = 'ERROR'
      GROUP BY Body ORDER BY count() DESC LIMIT 10

3. 유사 과거 에러 검색 (Vector Search)
   → 위 쿼리 5.1 실행

4. 연관 트레이스 분석
   → SELECT * FROM otel_traces WHERE TraceId IN (...)

5. 근본 원인 추론 및 보고
   → "Payment 서비스 에러의 근본 원인은 Inventory 서비스의 
      DB Connection Pool 고갈입니다. 과거 유사 케이스에서는 
      Pool 크기를 20→50으로 증가하여 해결했습니다."
```

**시나리오 2: 이상 패턴 탐지**
```
사용자: "현재 시스템에서 비정상적인 패턴이 있는지 확인해줘."

AI Agent 동작:
1. 최근 트레이스 이상 점수 계산
   → 쿼리 5.2 실행

2. 높은 이상 점수 트레이스 상세 분석
   → SELECT * FROM otel_traces WHERE TraceId = '...'

3. 해당 세션 확인
   → SELECT * FROM otel_sessions WHERE arrayExists(x -> x = '...', TraceIds)

4. 보고
   → "3개의 비정상 트레이스 패턴을 발견했습니다:
      1. checkout → payment 단계에서 비정상적인 재시도 (5회 이상)
      2. inventory 서비스 응답 시간 급증 (평균 대비 10배)
      ..."
```

**시나리오 3: 자연어 로그 검색**
```
사용자: "NullPointerException이랑 비슷한 에러 로그 찾아줘."

AI Agent 동작:
1. 쿼리 텍스트 임베딩 생성 (내부 처리)

2. Vector Search 실행
   → 쿼리 5.1 변형 실행

3. 결과 요약
   → "유사한 에러 패턴 5개를 찾았습니다:
      1. [2시간 전] UserService - NullPointerException at getUserById
      2. [1일 전] OrderService - NullReferenceException in processOrder
      ..."
```

---

## 7. 구현 단계

### Phase 1: 인프라 구축 (Day 1-2)

| Task | 상세 |
|------|------|
| AWS EC2 설정 | t3.medium, Ubuntu 22.04 |
| Docker 환경 구성 | Docker Compose |
| ClickHouse Cloud 설정 | Development tier, 스키마 생성 |
| HyperDX 배포 | Self-hosted docker-compose |

### Phase 2: 애플리케이션 개발 (Day 3-5)

| Task | 상세 |
|------|------|
| Sample App 개발 | FastAPI E-commerce |
| OTEL Instrumentation | Traces, Logs, Metrics |
| Data Generator 개발 | Traffic patterns, error injection |
| Session Replay 연동 | rrweb 통합 |

### Phase 3: Vector Search 파이프라인 (Day 6-7)

| Task | 상세 |
|------|------|
| Embedding 파이프라인 | Batch processing script |
| Vector 테이블 생성 | usearch 인덱스 |
| 샘플 데이터 embedding | 초기 데이터 처리 |

### Phase 4: Agentic AI 연동 (Day 8-9)

| Task | 상세 |
|------|------|
| MCP Server 설정 | Claude Desktop 연동 |
| 시나리오 테스트 | 3가지 시나리오 검증 |
| 프롬프트 최적화 | 정확도 개선 |

### Phase 5: 데모 준비 (Day 10)

| Task | 상세 |
|------|------|
| End-to-end 테스트 | 전체 플로우 검증 |
| 데모 스크립트 작성 | 발표용 시나리오 |
| 백업 영상 녹화 | 네트워크 이슈 대비 |

---

## 8. 디렉토리 구조
```
agentic-otel-demo/
├── docker-compose.yml           # 전체 스택 구성
├── README.md
│
├── sample-app/                  # FastAPI E-commerce
│   ├── Dockerfile
│   ├── requirements.txt
│   ├── main.py
│   ├── routers/
│   │   ├── products.py
│   │   ├── cart.py
│   │   ├── checkout.py
│   │   └── payment.py
│   ├── services/
│   │   ├── inventory.py
│   │   └── payment_gateway.py
│   └── otel_config.py
│
├── data-generator/              # 트래픽 생성기
│   ├── Dockerfile
│   ├── requirements.txt
│   ├── generator.py
│   ├── scenarios/
│   │   ├── normal_flow.py
│   │   ├── error_injection.py
│   │   └── anomaly_patterns.py
│   └── config.yaml
│
├── frontend/                    # 간단한 웹 프론트엔드
│   ├── Dockerfile
│   ├── index.html
│   ├── app.js
│   └── rrweb-config.js         # Session Replay
│
├── embedding-pipeline/          # Embedding 처리
│   ├── Dockerfile
│   ├── requirements.txt
│   ├── batch_processor.py
│   └── config.yaml
│
├── clickhouse/                  # 스키마 및 쿼리
│   ├── schemas/
│   │   ├── 01_otel_tables.sql
│   │   ├── 02_vector_tables.sql
│   │   └── 03_error_patterns.sql
│   └── queries/
│       ├── similar_error_search.sql
│       ├── anomaly_detection.sql
│       └── pattern_matching.sql
│
├── hyperdx/                     # HyperDX 설정
│   ├── docker-compose.yml
│   └── otel-collector-config.yaml
│
└── mcp/                         # MCP 설정
    └── claude_desktop_config.json

9. 예상 비용
항목사양월 예상 비용AWS EC2t3.medium~$30ClickHouse CloudDevelopment~$200 (demo 기간만)OpenAI Embeddingada-002~$10-20 (데모 데이터 기준)합계~$250/월
데모 기간(1-2주)만 사용 시 ~$100 이내

10. 성공 기준
항목기준데이터 생성분당 1000+ 로그, 100+ 트레이스Vector Search 응답< 200msHyperDX 연동Log/Trace/Session 정상 조회Agentic 워크플로우3가지 시나리오 성공적 데모E2E 안정성30분 연속 데모 가능

이 계획서를 기반으로 Workbench에서 구현을 시작하시면 됩니다.